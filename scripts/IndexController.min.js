/*! wedding - v0.0.0 - 2015-11-22 */
"use strict";angular.module("WeddingApp").directive("descriptionContent",function(){return{restrict:"E",scope:!1,link:function(a,b,c){a.getContentUrl=function(){return"templates/"+a.data.view+".html"}},template:'<div ng-include="getContentUrl()"></div>'}}).controller("IndexController",["$scope","$q","$timeout","_","Parse","Helper",function(a,b,c,d,e,f){function g(b){a.data.reservation.inProgress=!1,alert(b)}var h={firstName:"",lastName:"",initial:"",email:"",coming:!0},i="linear-gradient( rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5) )",j=function(b){a.$broadcast("backgroundImageBackdrop:update",b)};a.data={view:"home",party:{bridesmaids:[{name:"Imani Golding - Maid of Honor",description:"",avatar:"images/party/imaniGolding.jpg"},{name:"Kathleen Siapno",description:"",avatar:"images/party/kathleenSiapno.jpg"},{name:"Stephanie Shen",description:"",avatar:"images/party/stephanieShen.jpg"},{name:"Keisha Barry",description:"",avatar:"images/party/keishaBarry.jpg"},{name:"Krystianni Hills",description:"",avatar:"images/party/krystianniHills.jpg"}],groomsmen:[]},attendence:{attendies:[],notAttendies:[],addAttendies:function(b){a.data.attendence.attendies=a.data.attendence.attendies.concat(b)},addNotAttendies:function(b){a.data.attendence.notAttendies=a.data.attendence.notAttendies.concat(b)},hasEmail:function(a){return this.emails.indexOf(a)>-1},getEmails:function(a){var b="attendies"===a?this.attendies:this.notAttendies;return d.map(b,function(a){return a.email})},hasName:function(a){return this.names.indexOf(a)>-1},hasAttending:function(a){return this.hasAttendingOfType("attendies",a)},hasNotAttending:function(a){return this.hasAttendingOfType("notAttendies",a)},hasAttendingOfType:function(a,b){var c=this.getAttendieName(b,!1),d=!1,e=0,f="attendies"===a?this.attendies:this.notAttendies,g=f.length;for(e;g>e;e++)if(this.getAttendieName(f[e],!1)===c){f[e].email===b.email?d=!0:this.getAttendieName(f[e],!0)===this.getAttendieName(b,!0)&&(d=!0);break}return d},getAudienceNames:function(a,b){var c=this,e="attendies"===a?this.attendies:this.notAttendies;return d.map(e,function(a){return c.getAttendieName(a,b)})},getAttendiesNamesSeparatedByComma:function(a){var b=this,c="";return a.forEach(function(a,d){c+=(d?", ":"")+b.getAttendieName(a,!1)}),c},getAttendieName:function(a,b){return a.firstName+" "+a.lastName+(b?" "+a.initial:"")}},reservation:{inProgress:!1,songRequests:"",attendies:[d.clone(h)]},video:{source:"JI23BzW8kdA",height:"0",width:"1",player:null,playing:!1}};var k={initialized:!1,queried:null,ReservationCollector:null,initializeParse:function(){this.initialized||(e.initialize("7MSlb2EIj05DYLBlvWoHEc2PXbJYbEQKrog75wxa","jhpakFRx9LBOyru93ZoBQw5DH7xP5xLkllCja4MT"),this.initialized=!0,this.ReservationCollector=e.Object.extend("ReservationCollector"))},getParseReservationCollector:function(){return this.initializeParse(),new this.ReservationCollector},getParseReservations:function(){var b=this;if(b.initializeParse(),!b.queried){var c=new e.Query(b.ReservationCollector);c.find({success:function(c,d){a.$apply(function(){b.queried=!0,console.log(c),c.forEach(function(b){a.data.attendence.addAttendies(b.get("attending")),a.data.attendence.addNotAttendies(b.get("notAttending"))}),console.log(a.data.attendence.attendies),console.log(a.data.attendence.notAttendies)})},error:function(a){console.log("Error: "+a.code+" "+a.message)}})}}};a.getPage=function(b){b!==a.data.view&&(a.data.view="home",c(function(){"home"!==b&&(a.data.view=b)},300))},a.addNewAttendie=function(){a.data.reservation.attendies.push(d.clone(h))},a.removeAttendie=function(b){console.log(b),a.data.reservation.attendies.splice(a.data.reservation.attendies.indexOf(b),1)},a.$watch("data.view",function(a,b){a!==b&&("home"===a?j({backgroundShadow:""}):("rsvp"===a&&k.getParseReservations(),j({backgroundShadow:i})))}),a.makeReservation=function(){a.data.reservation.inProgress=!0;var b=d.cloneDeep(a.data.reservation),c="",e=0;b=d.pick(d.extend(b,d.map(b.attendies,d.partialRight(d.pick,d.keys(h)))),["songRequests","attendies"]),console.log(b);for(var i=0;i<b.attendies.length;i++)if(c="",(""===b.attendies[i].firstName||""===b.attendies[i].lastName)&&(c+="Please enter both first name and last name!"),""!==b.attendies[i].email&&(f.validateEmail(b.attendies[i].email)?e++:c+='Please enter correct email address(es)! Entered: "'+b.attendies[i].email+'".'),""!==c)return g(c);if(1>e)return g("We need at least one email address!");if(a.data.reservation.inProgress){b.songRequests=f.trimAndSplitStringList(b.songRequests);var j=d.partition(b.attendies,{coming:!0});delete b.attendies,b.attending=d.map(j[0].filter(function(b){return!a.data.attendence.hasAttending(b)}),d.partialRight(d.omit,["coming"])),b.notAttending=d.map(j[1].filter(function(b){return!a.data.attendence.hasNotAttending(b)}),d.partialRight(d.omit,["coming"]));d.reduce(b.attending,function(a,b){var c=b.firstName+" "+b.lastName;return a?a+", "+c:c},"");return console.log(b),b.attending.length||b.notAttending.length?void k.getParseReservationCollector().save(b).then(function(c){a.$apply(function(){a.data.attendence.addAttendies(b.attending),a.data.attendence.addNotAttendies(b.notAttending);var c=a.data.attendence.getAttendiesNamesSeparatedByComma(b.attending),d=a.data.attendence.getAttendiesNamesSeparatedByComma(b.notAttending),e="";c.length&&(e+="Thank you for making a reservation, "+c+"!"),d.length&&(e+=(c.length?" ":"")+"Sorry to hear that you are not attending, "+d+", but thank you for letting us know!"),g(e)})},function(b){a.$apply(function(){g("Sorry, there was a problem on our end :s. Please try hitting that button again!")})}):g("You already submitted your reservation before, please contact Kayla & Kostya directly!")}},a.$on("youtube.player.ready",function(a,b){console.log("player is ready"),b.playVideo()}),a.$on("youtube.player.ended",function(a,b){console.log("player video has ended")}),a.playOrPausePlayer=function(){"playing"===a.data.video.player.currentState?a.data.video.player.pauseVideo():a.data.video.player.playVideo()},a.stopPlayer=function(){a.data.video.player.stopVideo()}}]);